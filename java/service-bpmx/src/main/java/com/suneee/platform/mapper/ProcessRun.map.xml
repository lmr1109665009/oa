<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.suneee.platform.model.bpm.ProcessRun">
	<resultMap id="ProcessRun" type="com.suneee.platform.model.bpm.ProcessRun">
		<id property="runId" column="runId" jdbcType="NUMERIC"/>
		<result property="defId" column="defId" jdbcType="NUMERIC"/>
		<result property="subject" column="subject" jdbcType="VARCHAR"/>
		<result property="creatorId" column="creatorId" jdbcType="NUMERIC"/>
		<result property="creator" column="creator" jdbcType="VARCHAR"/>
		<result property="createtime" column="createtime" jdbcType="TIMESTAMP"/>
		<result property="busDescp" column="busDescp" jdbcType="VARCHAR"/>
		<result property="status" column="status" jdbcType="NUMERIC"/>
		<result property="actInstId" column="actInstId" jdbcType="VARCHAR"/>
		<result property="actDefId" column="actDefId" jdbcType="VARCHAR"/>
		<result property="businessKey" column="businessKey" jdbcType="VARCHAR"/>
		<result property="businessKeyNum" column="BUSINESSKEY_NUM" jdbcType="NUMERIC"/>
		<result property="businessUrl" column="businessUrl" jdbcType="VARCHAR"/>
		<result property="processName" column="processName" jdbcType="VARCHAR"/>
		<result property="endTime" column="endTime" jdbcType="TIMESTAMP"/>
		<result property="duration" column="duration" jdbcType="NUMERIC"/>
		<result property="lastSubmitDuration" column="lastSubmitDuration" jdbcType="NUMERIC"/>
		<result property="pkName" column="pkName" jdbcType="VARCHAR"/>
		<result property="tableName" column="tableName" jdbcType="VARCHAR"/>
		<result property="parentId" column="parentId" jdbcType="NUMERIC"/>
		<result property="startOrgId" column="startOrgId" jdbcType="NUMERIC"/>
		<result property="startOrgName"  column="startOrgName"  jdbcType="VARCHAR"/>
		<result property="typeId" column="typeId" jdbcType="NUMERIC"/>
		<result property="formKeyUrl" column="formKeyUrl" jdbcType="VARCHAR"/>
		<result property="formType" column="formType" jdbcType="NUMERIC"/>
		<result property="formDefId" column="formDefId" jdbcType="NUMERIC"/>
		<result property="flowKey" column="flowKey" jdbcType="VARCHAR"/>
		<result property="dsAlias" column="dsAlias" jdbcType="VARCHAR"/>
		<result property="isFormal" column="isFormal" jdbcType="NUMERIC"/>
		<result property="startNode" column="startNode" jdbcType="VARCHAR"/>
		<result property="relRunId" column="RELRUNID" jdbcType="NUMERIC"/>
		<result property="globalFlowNo" column="globalFlowNo" jdbcType="VARCHAR"/>
		<result property="startFromMobile" column="startFromMobile" jdbcType="NUMERIC"/>
		<result property="extend" column="extend" jdbcType="VARCHAR"/>
	</resultMap>

	<sql id="columns">
		runId,defId,subject,creatorId,creator,
		createtime,busDescp,status,actInstId,actDefId,
		businessKey,BUSINESSKEY_NUM,businessUrl,processName,endTime,duration,
		lastSubmitDuration,pkName,tableName,parentId,startOrgId,
		startOrgName,typeId,formKeyUrl,formType,formDefId,
		flowKey,dsAlias,isFormal,startNode,relRunId,globalFlowNo,startFromMobile,extend
	</sql>

	<sql id="runColumns">
		run.runId,run.defId,run.subject,run.creatorId,run.creator,run.createtime,run.busDescp,run.status,
		run.actInstId,run.actDefId,run.businessKey,run.BUSINESSKEY_NUM,
		run.businessUrl,run.processName,
		run.endTime,run.duration,run.lastSubmitDuration,run.pkName,run.tableName,run.parentId,
		run.startOrgId,run.startOrgName,
		run.typeId,run.formKeyUrl,run.formType,run.formDefId,run.flowKey,run.dsAlias,run.isFormal,run.startNode,run.relRunId,
		run.globalFlowNo,run.startFromMobile,run.extend
	</sql>

	<sql id="dynamicWhere2">
		<where>
			AND 1=1
			<if test="@Ognl@isNotEmpty(runId)"> AND run.runId  =#{runId} </if>
			<if test="@Ognl@isNotEmpty(defId)"> AND run.defId  =#{defId} </if>
			<if test="@Ognl@isNotEmpty(subject)"> AND run.subject  LIKE #{subject} ESCAPE '|' </if>
			<if test="@Ognl@isNotEmpty(creatorId)"> AND run.creatorId  =#{creatorId} </if>
			<if test="@Ognl@isNotEmpty(creator)"> AND run.creator  LIKE #{creator} ESCAPE '|' </if>
			<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
			<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
			<if test="@Ognl@isNotEmpty(endTime)"> AND run.endTime  =#{endTime} </if>
			<if test="@Ognl@isNotEmpty(busDescp)"> AND run.busDescp  LIKE #{busDescp} ESCAPE '|' </if>
			<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
			<if test="@Ognl@isNotEmpty(exceptDefStatus)"> AND def.status !=#{exceptDefStatus} </if>
			<if test="@Ognl@isNotEmpty(exceptStatus)"> AND run.status !=#{exceptStatus} </if>
			<if test="@Ognl@isNotEmpty(actInstId)"> AND run.actInstId  LIKE #{actInstId} ESCAPE '|' </if>
			<if test="@Ognl@isNotEmpty(actDefId)"> AND run.actDefId  LIKE #{actDefId} ESCAPE '|' </if>
			<if test="@Ognl@isNotEmpty(businessKey)"> AND run.businessKey  LIKE #{businessKey} ESCAPE '|' </if>
			<if test="@Ognl@isNotEmpty(businessUrl)"> AND run.businessUrl  LIKE #{businessUrl} ESCAPE '|' </if>
			<if test="@Ognl@isNotEmpty(processName)"> AND run.processName  LIKE #{processName} ESCAPE '|' </if>
			<if test="@Ognl@isNotEmpty(parentId)">AND run.parentId LIKE #{parentId} </if>
			<if test="@Ognl@isNotEmpty(startOrgId)">AND run.startOrgId LIKE #{startOrgId} ESCAPE '|' </if>
			<if test="@Ognl@isNotEmpty(startOrgName)"> AND run.startOrgName  LIKE #{startOrgName} ESCAPE '|' </if>
			<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalFlowNo  LIKE #{globalFlowNo} </if>
			<if test="@Ognl@isNotEmpty(searchCondition)"> AND (run.globalFlowNo  LIKE #{searchCondition} OR run.subject  LIKE #{searchCondition} OR run.processName  LIKE #{searchCondition} OR run.creator  LIKE #{searchCondition})</if>
			<if test="@Ognl@isNotEmpty(typeIdList)">
				AND run.typeId IN
				<foreach collection="typeIdList" item="typeId" open="(" separator="," close=")">
					#{typeId}
				</foreach>
			</if>
		</where>
	</sql>
	<!--表单自定义查询字段-->
	<sql id="queryFormTable">
		LEFT  JOIN ${formTable} ft ON run.BUSINESSKEY=ft.ID
	</sql>
	<sql id="queryFormWhere">
		<foreach collection="formParams" index="key" open=" AND (" close=")"
				 item="val" separator=" AND ">
			ft.${key} LIKE '%${val}%'
		</foreach>
	</sql>
	<!--可根据多个defid查询-->
	<select id="getAlreadyMattersListByDefIds" resultMap="ProcessRun">
		select distinct <include refid="runColumns"/>
		from BPM_PRO_RUN_HIS run  join ACT_HI_ACTINST tk on run.actInstId=tk.PROC_INST_ID_  and tk.isstart=0
		left join SYS_GL_TYPE type on run.typeId = type.typeId
		left join BPM_DEFINITION def on run.defId = def.defId
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormTable"/>
		</if>
		where tk.ASSIGNEE_=#{assignee}  and tk.end_time_ is not null and def.status!=3
		and run.status in (1,2,3,5,6,7)
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormWhere"/>
		</if>
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject}</if>
		<if test="@Ognl@isNotEmpty(creatorId)"> AND run.creatorId = #{creatorId}</if>
		<if test="@Ognl@isNotEmpty(defIds)">
			AND run.defId IN
			<foreach collection="defIds" item="defId" separator="," open="(" close=")">
				#{defId}
			</foreach>
		</if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(beginendTime)"> AND run.endTime  >=#{beginendTime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endendTime)"> AND <![CDATA[ run.endTime <= #{endendTime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<if test="@Ognl@isNotEmpty(processName)"> AND upper(run.processName)  LIKE #{processName} </if>
		<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>
		<if test="@Ognl@isNotEmpty(tagIds)"> AND def.tagIds LIKE #{tagIds} </if>
		<if test="@Ognl@isNotEmpty(nodeKey)"> and type.nodeKey in (${nodeKey}) </if>
		<if test="@Ognl@isNotEmpty(notNodeKey)"> and (type.nodeKey not in (${notNodeKey}) or type.nodeKey is NULL) </if>
		<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalFlowNo  LIKE #{globalFlowNo} </if>
		<if test="@Ognl@isNotEmpty(allowMobile)"> AND def.allowMobile  LIKE #{allowMobile} </if>
		<if test="@Ognl@isNotEmpty(searchCondition)"> AND (run.globalFlowNo  LIKE #{searchCondition} OR upper(run.processName)  LIKE #{searchCondition} OR run.creator LIKE #{searchCondition})</if>
		<if test="@Ognl@isNotEmpty(typeIds)"> AND run.TYPEID  in
			<foreach collection="typeIds" index="index" item="typeId" open="(" close=")" separator=",">
				#{typeId}
			</foreach>
		</if>
		<if test="@Ognl@isNotEmpty(orderField)">
			order by run.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by run.createtime  desc
		</if>
	</select>
	<insert id="add" parameterType="com.suneee.platform.model.bpm.ProcessRun">
		INSERT INTO bpm_pro_run
		(<include refid="columns"/>)
		VALUES
		(
		#{runId,jdbcType=NUMERIC},
		#{defId,jdbcType=NUMERIC},
		#{subject,jdbcType=VARCHAR},
		#{creatorId,jdbcType=NUMERIC},
		#{creator,jdbcType=VARCHAR},
		#{createtime,jdbcType=TIMESTAMP},
		#{busDescp,jdbcType=VARCHAR},
		#{status,jdbcType=NUMERIC},
		#{actInstId,jdbcType=VARCHAR},
		#{actDefId,jdbcType=VARCHAR},
		#{businessKey,jdbcType=VARCHAR},
		#{businessKeyNum,jdbcType=NUMERIC},
		#{businessUrl,jdbcType=VARCHAR},
		#{processName,jdbcType=VARCHAR},
		#{endTime,jdbcType=TIMESTAMP},
		#{duration,jdbcType=NUMERIC},
		#{lastSubmitDuration,jdbcType=NUMERIC},
		#{pkName,jdbcType=VARCHAR},
		#{tableName,jdbcType=VARCHAR},
		#{parentId,jdbcType=NUMERIC},
		#{startOrgId,jdbcType=NUMERIC},
		#{startOrgName,jdbcType=VARCHAR},
		#{typeId,jdbcType=NUMERIC},
		#{formKeyUrl,jdbcType=VARCHAR},
		#{formType,jdbcType=NUMERIC},
		#{formDefId,jdbcType=NUMERIC},
		#{flowKey,jdbcType=VARCHAR},
		#{dsAlias,jdbcType=VARCHAR},
		#{isFormal,jdbcType=NUMERIC},
		#{startNode,jdbcType=VARCHAR},
		#{relRunId,jdbcType=NUMERIC},
		#{globalFlowNo,jdbcType=VARCHAR},
		#{startFromMobile,jdbcType=NUMERIC},
		#{extend,jdbcType=VARCHAR}
		)</insert>



	<delete id="delById" parameterType="java.lang.Long">
		DELETE FROM BPM_PRO_RUN
		WHERE
		runId=#{runId}
	</delete>

	<update id="update" parameterType="com.suneee.platform.model.bpm.ProcessRun">
		UPDATE bpm_pro_run SET
		defId=#{defId,jdbcType=NUMERIC} ,
		subject=#{subject,jdbcType=VARCHAR} ,
		creatorId=#{creatorId,jdbcType=NUMERIC} ,
		creator=#{creator,jdbcType=VARCHAR} ,
		createtime=#{createtime,jdbcType=TIMESTAMP} ,
		busDescp=#{busDescp,jdbcType=VARCHAR} ,
		status=#{status,jdbcType=NUMERIC} ,
		actInstId=#{actInstId,jdbcType=VARCHAR} ,
		actDefId=#{actDefId,jdbcType=VARCHAR} ,
		businessKey=#{businessKey,jdbcType=VARCHAR} ,
		BUSINESSKEY_NUM=#{businessKeyNum,jdbcType=VARCHAR} ,
		businessUrl=#{businessUrl,jdbcType=VARCHAR} ,
		processName=#{processName,jdbcType=VARCHAR} ,
		endTime=#{endTime,jdbcType=TIMESTAMP} ,
		duration=#{duration,jdbcType=NUMERIC} ,
		pkName=#{pkName,jdbcType=VARCHAR} ,
		tableName=#{tableName,jdbcType=VARCHAR},
		parentId=#{parentId,jdbcType=NUMERIC} ,
		startOrgId=#{startOrgId,jdbcType=NUMERIC} ,
		startOrgName=#{startOrgName,jdbcType=VARCHAR},
		formDefId=#{formDefId,jdbcType=NUMERIC},
		isFormal=#{isFormal,jdbcType=NUMERIC},
		startNode=#{startNode,jdbcType=VARCHAR},
		relRunId=#{relRunId,jdbcType=NUMERIC},
		globalFlowNo=#{globalFlowNo,jdbcType=VARCHAR},
		startFromMobile=#{startFromMobile,jdbcType=NUMERIC},
		extend=#{extend,jdbcType=VARCHAR}
		WHERE
		runId=#{runId}
	</update>

	<update id="updateProcessNameByDefId">
		update BPM_PRO_RUN set processName=#{processName} where defId=#{defId}
	</update>

	<select id="getById" parameterType="java.lang.Long" resultMap="ProcessRun">
		SELECT run.* ,hi.END_TIME_ endTime,hi.DURATION_ duration
		FROM BPM_PRO_RUN run LEFT JOIN ACT_HI_PROCINST hi
		ON run.actInstId=hi.PROC_INST_ID_
		WHERE run.runId=#{runId}
	</select>

	<select id="getByActInstanceId" parameterType="long" resultMap="ProcessRun">
		SELECT * FROM BPM_PRO_RUN
		WHERE
		actInstId=#{actInstId}
	</select>

	<!--
	|
	|	History
	|
	-->
	<insert id="addHistory" parameterType="com.suneee.platform.model.bpm.ProcessRun">
		INSERT INTO BPM_PRO_RUN_HIS
		(<include refid="columns"/>)
		VALUES
		(
		#{runId,jdbcType=NUMERIC},
		#{defId,jdbcType=NUMERIC},
		#{subject,jdbcType=VARCHAR},
		#{creatorId,jdbcType=NUMERIC},
		#{creator,jdbcType=VARCHAR},
		#{createtime,jdbcType=TIMESTAMP},
		#{busDescp,jdbcType=VARCHAR},
		#{status,jdbcType=NUMERIC},
		#{actInstId,jdbcType=VARCHAR},
		#{actDefId,jdbcType=VARCHAR},
		#{businessKey,jdbcType=VARCHAR},
		#{businessKeyNum,jdbcType=NUMERIC},
		#{businessUrl,jdbcType=VARCHAR},
		#{processName,jdbcType=VARCHAR},
		#{endTime,jdbcType=TIMESTAMP},
		#{duration,jdbcType=NUMERIC},
		#{lastSubmitDuration,jdbcType=NUMERIC},
		#{pkName,jdbcType=VARCHAR},
		#{tableName,jdbcType=VARCHAR},
		#{parentId,jdbcType=NUMERIC},
		#{startOrgId,jdbcType=NUMERIC},
		#{startOrgName,jdbcType=VARCHAR},
		#{typeId,jdbcType=NUMERIC},
		#{formKeyUrl,jdbcType=VARCHAR},
		#{formType,jdbcType=NUMERIC},
		#{formDefId,jdbcType=NUMERIC},
		#{flowKey,jdbcType=VARCHAR},
		#{dsAlias,jdbcType=VARCHAR},
		#{isFormal,jdbcType=NUMERIC},
		#{startNode,jdbcType=VARCHAR},
		#{relRunId,jdbcType=NUMERIC},
		#{globalFlowNo,jdbcType=VARCHAR},
		#{startFromMobile,jdbcType=NUMERIC},
		#{extend,jdbcType=VARCHAR}
		)
	</insert>

	<delete id="delByIdHistory" parameterType="java.lang.Long">
		DELETE FROM BPM_PRO_RUN_HIS
		WHERE
		runId=#{runId}
	</delete>

	<update id="updateHistory" parameterType="com.suneee.platform.model.bpm.ProcessRun">
		UPDATE BPM_PRO_RUN_HIS SET
		defId=#{defId,jdbcType=NUMERIC} ,
		subject=#{subject,jdbcType=VARCHAR} ,
		creatorId=#{creatorId,jdbcType=NUMERIC} ,
		creator=#{creator,jdbcType=VARCHAR} ,
		createtime=#{createtime,jdbcType=TIMESTAMP} ,
		busDescp=#{busDescp,jdbcType=VARCHAR} ,
		status=#{status,jdbcType=NUMERIC} ,
		actInstId=#{actInstId,jdbcType=VARCHAR} ,
		actDefId=#{actDefId,jdbcType=VARCHAR} ,
		businessKey=#{businessKey,jdbcType=VARCHAR} ,
		BUSINESSKEY_NUM=#{businessKeyNum,jdbcType=VARCHAR} ,
		businessUrl=#{businessUrl,jdbcType=VARCHAR} ,
		processName=#{processName,jdbcType=VARCHAR} ,
		endTime=#{endTime,jdbcType=TIMESTAMP} ,
		duration=#{duration,jdbcType=NUMERIC} ,
		lastSubmitDuration=#{lastSubmitDuration,jdbcType=NUMERIC} ,
		pkName=#{pkName,jdbcType=VARCHAR} ,
		tableName=#{tableName,jdbcType=VARCHAR},
		parentId=#{parentId,jdbcType=NUMERIC} ,
		startOrgId=#{startOrgId,jdbcType=NUMERIC} ,
		startOrgName=#{startOrgName,jdbcType=VARCHAR},
		typeId=#{typeId,jdbcType=NUMERIC},
		formKeyUrl=#{formKeyUrl,jdbcType=VARCHAR},
		formType=#{formType,jdbcType=NUMERIC},
		startNode=#{startNode,jdbcType=VARCHAR},
		relRunId=#{relRunId,jdbcType=NUMERIC},
		globalFlowNo=#{globalFlowNo,jdbcType=VARCHAR},
		startFromMobile=#{startFromMobile,jdbcType=NUMERIC},
		extend=#{extend,jdbcType=VARCHAR}
		WHERE
		runId=#{runId}
	</update>

	<select id="getByActInstanceIdHistory" parameterType="long" resultMap="ProcessRun">
		SELECT <include refid="columns"/> FROM BPM_PRO_RUN_HIS
		WHERE
		actInstId=#{actInstId}
	</select>

	<select id="getAll" resultMap="ProcessRun">
		SELECT run.*
		FROM BPM_PRO_RUN_HIS run
		LEFT JOIN BPM_DEFINITION def
		ON run.actDefId=def.actDefId
		<include refid="dynamicWhere2" />
		<!-- 按用户授权过滤用户的流程 ：isNeedRight为空时不需要按权限查询，否则按流程的分管授权情况查询-->
		<if test="@Ognl@isNotEmpty(isNeedRight)">
			<if test="@Ognl@isNotEmpty(actRights)">
				AND def.defKey in(${actRights})
			</if>
			<if test="@Ognl@isEmpty(actRights)">
				AND def.defKey = ''
			</if>
		</if>
		<if test="@Ognl@isNotEmpty(typeIds)"> AND run.TYPEID  in
			<foreach collection="typeIds" index="index" item="typeId" open="(" close=")" separator=",">
				#{typeId}
			</foreach>
		</if>
		<if test="@Ognl@isNotEmpty(actDefKey)">
			AND def.ACTDEFKEY=#{actDefKey}
		</if>
		<if test="@Ognl@isNotEmpty(orderField)">
			order by run.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by run.createtime  desc
		</if>
	</select>
	<!--根据流程ID进行分类统计-->
	<select id="getAllCount" resultType="com.suneee.oa.model.bpm.ProcessRunAmount">
		SELECT def.defId,count(def.defId) total
		FROM BPM_PRO_RUN_HIS run
		LEFT JOIN BPM_DEFINITION def
		ON run.actDefId=def.actDefId
		<include refid="dynamicWhere2" />
		<!-- 按用户授权过滤用户的流程 ：isNeedRight为空时不需要按权限查询，否则按流程的分管授权情况查询-->
		<if test="@Ognl@isNotEmpty(isNeedRight)">
			<if test="@Ognl@isNotEmpty(actRights)">
				AND def.defKey in(${actRights})
			</if>
			<if test="@Ognl@isEmpty(actRights)">
				AND def.defKey = ''
			</if>
		</if>
		GROUP BY def.defId
	</select>

	<select id="getByIdHistory" parameterType="java.lang.Long" resultMap="ProcessRun">
		SELECT run.* ,hi.END_TIME_ endTime,hi.DURATION_ duration
		FROM BPM_PRO_RUN_HIS run LEFT JOIN ACT_HI_PROCINST hi
		ON run.actInstId=hi.PROC_INST_ID_
		WHERE run.runId=#{runId}
	</select>

	<select id="getTestRunsByActDefId" parameterType="java.lang.String"  resultMap="ProcessRun">
		SELECT run.* From BPM_PRO_RUN_HIS run
		WHERE run.actDefId=#{actDefId}
		AND	run.isFormal=0
	</select>

	<select id="getByBusinessKey" parameterType="java.lang.String" resultMap="ProcessRun">
		SELECT * FROM BPM_PRO_RUN_HIS
		WHERE
		parentId=0
		AND
		businessKey=#{businessKey}
	</select>

	<select id="getByBusinessKeyNum" parameterType="java.lang.Long" resultMap="ProcessRun">
		SELECT * FROM BPM_PRO_RUN
		WHERE
		parentId=0
		AND
		BUSINESSKEY_NUM=#{businessKeyNum}
	</select>

	<select id="getMonitor" resultMap="ProcessRun">
		SELECT runid,
		defid,
		processname,
		subject,
		creatorid,
		creator,
		createtime,
		busdescp,
		status,
		actdefid,
		endtime,
		DURATION,
		parentid,
		startorgid,
		startorgname,
		typeid,
		actinstid,
		lastsubmitduration,
		per.flowkey,
		per.grade
		FROM bpm_pro_run_his his,
		(SELECT org.orgid, max(tmp.grade) grade, tmp.flowkey
		FROM sys_org org,
		(SELECT rights.*, t.PATH
		FROM (SELECT MAX(a.grade) grade, b.flowkey, d.orgid
		FROM bpm_mon_group     a,
		bpm_mon_groupitem b,
		bpm_mon_orgrole   d,
		sys_user_role     e
		WHERE a.enabled = 1
		AND a.ID = b.groupid
		AND a.ID = d.groupid
		AND e.roleid = d.roleid
		AND e.userid =  #{curUser}
		GROUP BY b.flowkey, d.orgid) rights,
		sys_org t
		WHERE rights.orgid = t.orgid) tmp
		WHERE org.PATH LIKE tmp.PATH || '%'
		GROUP BY ORG.ORGID, TMP.FLOWKEY)per
		WHERE his.startorgid = per.orgid
		AND per.flowkey = his.flowkey

		<if test="@Ognl@isNotEmpty(creatorid)"> and his.creatorid= #{creatorid} </if>
		<if test="@Ognl@isNotEmpty(status)"> and his.status= #{status} </if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND his.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ his.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(processname)"> AND upper(his.processname) like #{processname,jdbcType=VARCHAR}  ESCAPE '|'  </if>
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(his.subject) like #{subject,jdbcType=VARCHAR}  ESCAPE '|'  </if>
		<if test="@Ognl@isNotEmpty(orderField)">
			order by his.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by his.createtime  desc
		</if>

	</select>
	<select id="getByRunId" parameterType="java.lang.String" resultMap="ProcessRun">
		SELECT * FROM BPM_PRO_RUN
		WHERE
		parentId=0
		AND
		runId=#{runId}
	</select>
	<select id="getMyAttend" resultMap="ProcessRun">
		select count(distinct run.actInstId) countNum,run.runId,run.defId,run.subject,run.creatorId,run.creator,run.createtime,run.busDescp,run.status,run.actInstId,run.actDefId,run.businessKey,run.businessUrl,run.processName,run.endTime,run.duration,run.pkName,run.tableName,run.parentId,run.startOrgId,run.startOrgName
		from BPM_PRO_RUN_HIS run left join ACT_HI_TASKINST tk on run.actInstId=tk.PROC_INST_ID_
		where tk.ASSIGNEE_=#{assignee}
		<if test="@Ognl@isNotEmpty(subject)"> AND run.subject  LIKE #{subject} ESCAPE '|' </if>
		<if test="@Ognl@isNotEmpty(creator)"> AND run.creator  LIKE #{creator} ESCAPE '|' </if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(beginendTime)"> AND run.endTime  >=#{beginendTime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endendTime)"> AND <![CDATA[ run.endTime <= #{endendTime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(endTime)"> AND run.endTime  =#{endTime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(busDescp)"> AND run.busDescp  LIKE #{busDescp} ESCAPE '|' </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<if test="@Ognl@isNotEmpty(processName)"> AND run.processName  LIKE #{processName} ESCAPE '|' </if>
		group by run.runId,run.defId,run.subject,run.creatorId,run.creator,run.createtime,run.busDescp,run.status,run.actInstId,run.actDefId,run.businessKey,run.businessUrl,run.processName,run.endTime,run.duration,run.pkName,run.tableName,run.parentId,run.startOrgId,run.startOrgName
		<if test="@Ognl@isNotEmpty(orderField)">
			order by ${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by createtime  desc
		</if>
	</select>

	<select id="getAllFinish" resultMap="ProcessRun">
		SELECT run.*
		FROM BPM_PRO_RUN_HIS run
		LEFT JOIN BPM_DEFINITION def
		ON  run.actDefId=def.actDefId
		where run.status>=2 and run.status!=4 and def.status!=3
		<if test="@Ognl@isNotEmpty(subject)"> AND run.subject  LIKE #{subject} ESCAPE '|' </if>
		<if test="@Ognl@isNotEmpty(creator)"> AND run.creator  LIKE #{creator} ESCAPE '|' </if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime}  ]]> </if>
		<if test="@Ognl@isNotEmpty(beginendTime)"> AND run.endTime  >=#{beginendTime} </if>
		<if test="@Ognl@isNotEmpty(endendTime)"> AND <![CDATA[ run.endTime <= #{endendTime}  ]]> </if>
		<if test="@Ognl@isNotEmpty(endTime)"> AND run.endTime  =#{endTime} </if>
		<if test="@Ognl@isNotEmpty(busDescp)"> AND run.busDescp  LIKE #{busDescp} ESCAPE '|' </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<if test="@Ognl@isNotEmpty(processName)"> AND run.processName  LIKE #{processName} ESCAPE '|' </if>
		<if test="@Ognl@isNotEmpty(orderField)">
			order by run.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by run.createtime  desc
		</if>
	</select>
	<select id="getMyProcessRun" resultMap="ProcessRun">
		SELECT * FROM BPM_PRO_RUN_HIS run where 1=1
		<if test="@Ognl@isNotEmpty(subject)"> AND run.subject  LIKE #{subject} ESCAPE '|' </if>
		<if test="@Ognl@isNotEmpty(creatorId)"> AND run.creatorId=#{creatorId}  </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
	</select>

	<select id="getbyActDefId" parameterType="java.lang.String" resultMap="ProcessRun">
		SELECT * FROM BPM_PRO_RUN_HIS
		WHERE
		actDefId=#{actDefId}
	</select>

	<delete id="delByActDefId" parameterType="java.lang.String">
		DELETE FROM BPM_PRO_RUN
		WHERE
		actDefId=#{actDefId}
	</delete>

	<delete id="delHistroryByActDefId" parameterType="java.lang.String">
		DELETE FROM BPM_PRO_RUN_HIS
		WHERE
		actDefId=#{actDefId}
	</delete>

	<select id="getMyDraft" resultMap="ProcessRun">
		SELECT run.* FROM BPM_PRO_RUN run
		left join BPM_DEFINITION def on run.defId = def.defId
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormTable"/>
		</if>
		WHERE
		run.creatorId=#{userId} AND run.status=4 and def.status!=3
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormWhere"/>
		</if>
		<if test="@Ognl@isNotEmpty(subject)"> AND run.subject  LIKE #{subject} ESCAPE '|' </if>
		<if test="@Ognl@isNotEmpty(startFromMobile)"> AND run.startFromMobile =#{startFromMobile} </if>
		<if test="@Ognl@isNotEmpty(defId)">
			AND run.defId=#{defId}
		</if>
		<if test="@Ognl@isNotEmpty(defIds)">
			AND run.defId IN
			<foreach collection="defIds" item="defId" open="(" close=")" separator="," >
				#{defId}
			</foreach>
		</if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime}  ]]> </if>
		<if test="@Ognl@isNotEmpty(processName)"> AND run.processName  LIKE #{processName} ESCAPE '|' </if>
		<if test="@Ognl@isNotEmpty(searchCondition)"> AND (run.processName  LIKE #{searchCondition} ESCAPE '|' OR run.subject  LIKE #{searchCondition})</if>
		<if test="@Ognl@isNotEmpty(typeIds)"> AND def.TYPEID  in
			<foreach collection="typeIds" index="index" item="typeId" open="(" close=")" separator=",">
				#{typeId}
			</foreach>
		</if>
		<if test="@Ognl@isNotEmpty(orderField)">
			order by run.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by run.createtime  desc
		</if>
	</select>


	<select id="getMyRequestCompletedList" resultMap="ProcessRun">
		select distinct <include refid="runColumns"/>,task.ID_ taskId,task.NAME_ taskName,task.ASSIGNEE_ assignee,type.typeName
		from BPM_PRO_RUN_HIS run
		left join SYS_GL_TYPE type on run.typeId = type.typeId
		left join BPM_DEFINITION def on run.defId = def.defId
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormTable"/>
		</if>
		LEFT JOIN act_ru_task task  on task.PROC_INST_ID_ =run.ACTINSTID
		where run.creatorId =#{creatorId}  and def.status!=3
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormWhere"/>
		</if>
		<choose>
			<when test="flag == 1">
				AND run.status in (1,5,6,7)
			</when>
			<when test="flag == 2">
				AND run.status in (2,3)
			</when>
			<otherwise>
				AND run.status in (1,2,3,5,6,7)
			</otherwise>
		</choose>
		<if test="@Ognl@isNotEmpty(defId)"> AND run.defId  = #{defId} </if>
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject} </if>
		<if test="@Ognl@isNotEmpty(creator)"> AND run.creator  LIKE #{creator}  </if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<if test="@Ognl@isNotEmpty(processName)"> AND upper(run.processName)  LIKE #{processName}  </if>
		<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>
		<if test="@Ognl@isNotEmpty(nodeKey)"> and type.nodeKey in (${nodeKey}) </if>
		<if test="@Ognl@isNotEmpty(notNodeKey)"> and (type.nodeKey not in (${notNodeKey}) or type.nodeKey is NULL) </if>


		<if test="@Ognl@isNotEmpty(orderField)">
			order by run.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by run.createtime  desc
		</if>
	</select>

	<!-- 我的请求 -->
	<select id="getMyRequestList" resultMap="ProcessRun">
		select distinct <include refid="runColumns"/>,type.typeName
		from BPM_PRO_RUN_HIS run
		left join SYS_GL_TYPE type on run.typeId = type.typeId
		left join BPM_DEFINITION def on run.defId = def.defId
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormTable"/>
		</if>
		where run.creatorId =#{creatorId} and run.status in (1,5,6,7) and def.status!=3
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormWhere"/>
		</if>
		<if test="@Ognl@isNotEmpty(defId)"> AND run.defId  =#{defId} </if>
		<if test="@Ognl@isNotEmpty(defIds)">
			AND run.defId IN
			<foreach collection="defIds" item="defId" open="(" close=")" separator="," >
				#{defId}
			</foreach>
		</if>
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject} </if>
		<if test="@Ognl@isNotEmpty(creator)"> AND run.creator  LIKE #{creator}  </if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<!--<if test="@Ognl@isNotEmpty(typeId)"> AND run.typeId  =#{typeId} </if>-->
		<if test="@Ognl@isNotEmpty(processName)"> AND upper(run.processName)  LIKE #{processName}  </if>
		<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>
		<if test="@Ognl@isNotEmpty(nodeKey)"> and type.nodeKey in (${nodeKey}) </if>
		<if test="@Ognl@isNotEmpty(notNodeKey)"> and (type.nodeKey not in (${notNodeKey}) or type.nodeKey is NULL) </if>
		<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalFlowNo  LIKE #{globalFlowNo} </if>
		<if test="@Ognl@isNotEmpty(allowMobile)"> AND def.allowMobile  =#{allowMobile} </if>
		<if test="@Ognl@isNotEmpty(searchCondition)"> AND (run.globalFlowNo  LIKE #{searchCondition} OR upper(run.processName)  LIKE #{searchCondition})</if>
		<if test="@Ognl@isNotEmpty(typeIds)"> AND run.TYPEID  in
			<foreach collection="typeIds" index="index" item="typeId" open="(" close=")" separator=",">
				#{typeId}
			</foreach>
		</if>
		<if test="@Ognl@isNotEmpty(orderField)">
			order by run.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by run.createtime  desc
		</if>
	</select>
	<!--获取流程我的申请分类统计数据-->
	<select id="getFlowMyRequestCount" resultType="com.suneee.oa.model.bpm.ProcessRunAmount">
		select distinct run.defid as defId,count(distinct run.runid) total
		from BPM_PRO_RUN_HIS run
		left join SYS_GL_TYPE type on run.typeId = type.typeId
		left join BPM_DEFINITION def on run.defId = def.defId
		where run.creatorId =#{creatorId} and run.status in (1,5,6,7) and def.status!=3
		<if test="@Ognl@isNotEmpty(defId)"> AND run.defId  =#{defId} </if>
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject} </if>
		<if test="@Ognl@isNotEmpty(creator)"> AND run.creator  LIKE #{creator}  </if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<if test="@Ognl@isNotEmpty(typeId)"> AND run.typeId  =#{typeId} </if>
		<if test="@Ognl@isNotEmpty(typeIdList)">
			AND def.typeId IN
			<foreach collection="typeIdList" item="typeId" open="(" separator="," close=")">
				#{typeId}
			</foreach>
		</if>
		<if test="@Ognl@isNotEmpty(processName)"> AND upper(run.processName)  LIKE #{processName}  </if>
		<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>
		<if test="@Ognl@isNotEmpty(nodeKey)"> and type.nodeKey in (${nodeKey}) </if>
		<if test="@Ognl@isNotEmpty(notNodeKey)"> and (type.nodeKey not in (${notNodeKey}) or type.nodeKey is NULL) </if>
		<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalFlowNo  LIKE #{globalFlowNo} </if>
		<if test="@Ognl@isNotEmpty(allowMobile)"> AND def.allowMobile  =#{allowMobile} </if>
		GROUP BY run.defid
	</select>

	<!-- 我的办结 -->
	<select id="getMyCompletedList" resultMap="ProcessRun">
		select distinct <include refid="runColumns"/>,type.typeName,
		def.isPrintForm isPrintForm,def.allowFinishedDivert allowFinishedDivert
		from BPM_PRO_RUN_HIS run
		left join SYS_GL_TYPE type on run.typeId = type.typeId
		left join BPM_DEFINITION def on run.defId = def.defId
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormTable"/>
		</if>
		where creatorId =#{creatorId} AND ( run.status = 2 or  run.status = 3 ) and def.status!=3
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormWhere"/>
		</if>
		<if test="@Ognl@isNotEmpty(defId)"> AND run.defId  = #{defId} </if>
		<if test="@Ognl@isNotEmpty(defIds)">
			AND run.defId IN
			<foreach collection="defIds" item="defId" open="(" close=")" separator="," >
				#{defId}
			</foreach>
		</if>
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject} </if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<!--<if test="@Ognl@isNotEmpty(typeId)"> AND run.typeId  =#{typeId} </if>-->
		<if test="@Ognl@isNotEmpty(processName)"> AND upper(run.processName)  LIKE #{processName}  </if>
		<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>
		<if test="@Ognl@isNotEmpty(nodeKey)"> and type.nodeKey in (${nodeKey}) </if>
		<if test="@Ognl@isNotEmpty(notNodeKey)"> and (type.nodeKey not in (${notNodeKey}) or type.nodeKey is NULL) </if>
		<if test="@Ognl@isNotEmpty(tagIds)"> AND def.tagIds LIKE #{tagIds} </if>
		<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalFlowNo  LIKE #{globalFlowNo} </if>
		<if test="@Ognl@isNotEmpty(allowMobile)"> AND def.allowMobile  =#{allowMobile} </if>
		<if test="@Ognl@isNotEmpty(searchCondition)"> AND (run.globalFlowNo  LIKE #{searchCondition} OR upper(run.processName)  LIKE #{searchCondition})</if>
		<if test="@Ognl@isNotEmpty(typeIds)"> AND run.TYPEID  in
			<foreach collection="typeIds" index="index" item="typeId" open="(" close=")" separator=",">
				#{typeId}
			</foreach>
		</if>
		<if test="@Ognl@isNotEmpty(orderField)">
			order by run.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by run.createtime  desc
		</if>
	</select>
	<!--获取流程我的办结分类统计数据-->
	<select id="getFlowMyCompletedCount" resultType="com.suneee.oa.model.bpm.ProcessRunAmount">
		select distinct run.defid as defId,count(distinct run.runid) total
		from BPM_PRO_RUN_HIS run
		left join SYS_GL_TYPE type on run.typeId = type.typeId
		left join BPM_DEFINITION def on run.defId = def.defId
		where creatorId =#{creatorId} AND ( run.status = 2 or  run.status = 3 ) and def.status!=3
		<if test="@Ognl@isNotEmpty(defId)"> AND run.defId  = #{defId} </if>
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject} </if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<if test="@Ognl@isNotEmpty(typeId)"> AND run.typeId  =#{typeId} </if>
		<if test="@Ognl@isNotEmpty(typeIdList)">
			AND def.typeId IN
			<foreach collection="typeIdList" item="typeId" open="(" separator="," close=")">
				#{typeId}
			</foreach>
		</if>
		<if test="@Ognl@isNotEmpty(processName)"> AND upper(run.processName)  LIKE #{processName}  </if>
		<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>
		<if test="@Ognl@isNotEmpty(nodeKey)"> and type.nodeKey in (${nodeKey}) </if>
		<if test="@Ognl@isNotEmpty(notNodeKey)"> and (type.nodeKey not in (${notNodeKey}) or type.nodeKey is NULL) </if>
		<if test="@Ognl@isNotEmpty(tagIds)"> AND def.tagIds LIKE #{tagIds} </if>
		<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalFlowNo  LIKE #{globalFlowNo} </if>
		<if test="@Ognl@isNotEmpty(allowMobile)"> AND def.allowMobile  =#{allowMobile} </if>
		GROUP BY run.defid
	</select>

	<!-- 通过defKey查找我的办结 -->
	<select id="getByUserIdAndDefKey" resultMap="ProcessRun">
		select distinct <include refid="runColumns"/>,type.typeName,
		def.isPrintForm isPrintForm,def.allowFinishedDivert allowFinishedDivert
		from BPM_PRO_RUN_HIS run
		left join SYS_GL_TYPE type on run.typeId = type.typeId
		left join BPM_DEFINITION def on run.defId = def.defId
		where creatorId =#{creatorId} AND def.defKey=#{defKey} AND ( run.status = 2 or  run.status = 3 ) and def.status!=3

		order by run.createtime  desc

	</select>


	<!-- 已办办结事宜  -->
	<select id="getAlreadyCompletedMattersList" resultMap="ProcessRun">
		select distinct <include refid="runColumns"/>
		from BPM_PRO_RUN_HIS run  join ACT_HI_ACTINST tk on run.actInstId=tk.PROC_INST_ID_  and tk.isstart=0
		left join SYS_GL_TYPE type on run.typeId = type.typeId
		left join BPM_DEFINITION def on run.defId = def.defId
		where tk.ASSIGNEE_=#{assignee}  and def.status!=3
		<choose>
			<when test="flag == 1">
				AND tk.end_time_ is not null
			</when>
			<when test="flag == 2">
				AND run.status in (2,3)
			</when>
			<otherwise>
				AND (run.status in (2,3) or tk.end_time_ is not null)
			</otherwise>
		</choose>

		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject}</if>
		<if test="@Ognl@isNotEmpty(creatorId)"> AND run.creatorId = #{creatorId}</if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(beginendTime)"> AND run.endTime  >=#{beginendTime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endendTime)"> AND <![CDATA[ run.endTime <= #{endendTime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<if test="@Ognl@isNotEmpty(processName)"> AND upper(run.processName)  LIKE #{processName} </if>
		<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>
		<if test="@Ognl@isNotEmpty(tagIds)"> AND def.tagIds LIKE #{tagIds} </if>
		<if test="@Ognl@isNotEmpty(nodeKey)"> and type.nodeKey in (${nodeKey}) </if>
		<if test="@Ognl@isNotEmpty(notNodeKey)"> and (type.nodeKey not in (${notNodeKey}) or type.nodeKey is NULL) </if>
		<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalFlowNo  LIKE #{globalFlowNo} </if>

		<if test="@Ognl@isNotEmpty(orderField)">
			order by run.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by run.createtime  desc
		</if>
	</select>
	<!--所有与我相关的流程-->
	<select id="getAllFlowsList" resultMap="ProcessRun">
		select distinct <include refid="runColumns"/>
		from BPM_PRO_RUN_HIS run  join ACT_HI_ACTINST tk on run.actInstId=tk.PROC_INST_ID_  and tk.isstart=0
		left join SYS_GL_TYPE type on run.typeId = type.typeId
		left join BPM_DEFINITION def on run.defId = def.defId
		where tk.ASSIGNEE_=#{assignee}  and def.status!=3
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject}</if>
		<if test="@Ognl@isNotEmpty(creatorId)"> AND run.creatorId = #{creatorId}</if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(beginendTime)"> AND run.endTime  >=#{beginendTime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endendTime)"> AND <![CDATA[ run.endTime <= #{endendTime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<if test="@Ognl@isNotEmpty(processName)"> AND upper(run.processName)  LIKE #{processName} </if>
		<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>
		<if test="@Ognl@isNotEmpty(tagIds)"> AND def.tagIds LIKE #{tagIds} </if>
		<if test="@Ognl@isNotEmpty(nodeKey)"> and type.nodeKey in (${nodeKey}) </if>
		<if test="@Ognl@isNotEmpty(notNodeKey)"> and (type.nodeKey not in (${notNodeKey}) or type.nodeKey is NULL) </if>
		<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalFlowNo  LIKE #{globalFlowNo} </if>
		<if test="@Ognl@isNotEmpty(orderField)">
			order by run.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by run.createtime  desc
		</if>
	</select>

	<!-- 已办事宜  并且结束时间不为空
	1 正在运行,2 结束，3 人工终止，5,已撤销,6,已退回 7,已追回
	-->
	<!-- <select id="getAlreadyMattersList" resultMap="ProcessRun">
		select distinct <include refid="runColumns"/>,
		( case when tread.id is NULL then 0 else 1 end) hasRead
		from BPM_PRO_RUN_HIS run  join ACT_HI_ACTINST tk on run.actInstId=tk.PROC_INST_ID_  and tk.isstart=0
		left join SYS_GL_TYPE type on run.typeId = type.typeId
		left join BPM_DEFINITION def on run.defId = def.defId
		LEFT JOIN bpm_task_read tread  ON tk.TASK_ID_ = tread.TASKID
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormTable"/>
		</if>
 		where tk.ASSIGNEE_=#{assignee}  and tk.end_time_ is not null and def.status!=3
 		and run.status in (1,2,3,5,6,7)
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormWhere"/>
		</if>
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject}</if>
		<if test="@Ognl@isNotEmpty(creatorId)"> AND run.creatorId = #{creatorId}</if>
		<if test="@Ognl@isNotEmpty(defId)"> AND run.defId = #{defId}</if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(beginendTime)"> AND run.endTime  >=#{beginendTime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endendTime)"> AND <![CDATA[ run.endTime <= #{endendTime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<if test="@Ognl@isNotEmpty(processName)"> AND upper(run.processName)  LIKE #{processName} </if>
		<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>
		<if test="@Ognl@isNotEmpty(tagIds)"> AND def.tagIds LIKE #{tagIds} </if>
		<if test="@Ognl@isNotEmpty(nodeKey)"> and type.nodeKey in (${nodeKey}) </if>
		<if test="@Ognl@isNotEmpty(notNodeKey)"> and (type.nodeKey not in (${notNodeKey}) or type.nodeKey is NULL) </if>
		<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalFlowNo  LIKE #{globalFlowNo} </if>
		<if test="@Ognl@isNotEmpty(allowMobile)"> AND def.allowMobile  LIKE #{allowMobile} </if>
		<if test="@Ognl@isNotEmpty(searchCondition)"> AND (run.globalFlowNo  LIKE #{searchCondition} OR upper(run.processName)  LIKE #{searchCondition} OR run.creator LIKE #{searchCondition})</if>
		<if test="@Ognl@isNotEmpty(typeIds)"> AND run.TYPEID  in
			<foreach collection="typeIds" index="index" item="typeId" open="(" close=")" separator=",">
				#{typeId}
			</foreach>
		</if>
		<if test="@Ognl@isNotEmpty(orderField)">
		order by run.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
		order by run.createtime  desc
		</if>
	</select> -->
	<!-- 外部系统调用 已办事宜  并且结束时间不为空
        1 正在运行,2 结束，3 人工终止，5,已撤销,6,已退回 7,已追回
        -->
	<select id="getAlreadyMattersLists" resultMap="ProcessRun">
		select distinct <include refid="runColumns"/>,
		( case when tread.id is NULL then 0 else 1 end) hasRead
		from BPM_PRO_RUN_HIS run  join ACT_HI_ACTINST tk on run.actInstId=tk.PROC_INST_ID_  and tk.isstart=0
		left join SYS_GL_TYPE type on run.typeId = type.typeId
		left join SYS_PER_OFFICE office on run.runId = office.runId
		left join BPM_DEFINITION def on run.defId = def.defId
		LEFT JOIN bpm_task_read tread  ON tk.TASK_ID_ = tread.TASKID
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormTable"/>
		</if>
		where tk.ASSIGNEE_=#{assignee}  and tk.end_time_ is not null and def.status!=3
		and run.status in (1,2,3,5,6,7) and office.comeFrom = 1
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormWhere"/>
		</if>
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject}</if>
		<if test="@Ognl@isNotEmpty(creatorId)"> AND run.creatorId = #{creatorId}</if>
		<if test="@Ognl@isNotEmpty(defId)"> AND run.defId = #{defId}</if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(beginendTime)"> AND run.endTime  >=#{beginendTime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endendTime)"> AND <![CDATA[ run.endTime <= #{endendTime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<if test="@Ognl@isNotEmpty(processName)"> AND upper(run.processName)  LIKE #{processName} </if>
		<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>
		<if test="@Ognl@isNotEmpty(tagIds)"> AND def.tagIds LIKE #{tagIds} </if>
		<if test="@Ognl@isNotEmpty(nodeKey)"> and type.nodeKey in (${nodeKey}) </if>
		<if test="@Ognl@isNotEmpty(notNodeKey)"> and (type.nodeKey not in (${notNodeKey}) or type.nodeKey is NULL) </if>
		<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalFlowNo  LIKE #{globalFlowNo} </if>
		<if test="@Ognl@isNotEmpty(allowMobile)"> AND def.allowMobile  LIKE #{allowMobile} </if>
		<if test="@Ognl@isNotEmpty(searchCondition)"> AND (run.globalFlowNo  LIKE #{searchCondition} OR upper(run.processName)  LIKE #{searchCondition} OR run.creator LIKE #{searchCondition})</if>
		<if test="@Ognl@isNotEmpty(typeIds)"> AND run.TYPEID  in
			<foreach collection="typeIds" index="index" item="typeId" open="(" close=")" separator=",">
				#{typeId}
			</foreach>
		</if>
		<if test="@Ognl@isNotEmpty(orderField)">
			order by run.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by run.createtime  desc
		</if>
	</select>
	<select id="getAlreadyMattersList" resultMap="ProcessRun">
		select distinct <include refid="runColumns"/>,
		( case when tread.id is NULL then 0 else 1 end) IN (0,1) hasRead
		from BPM_PRO_RUN_HIS run  join ACT_HI_ACTINST tk on run.actInstId=tk.PROC_INST_ID_  and tk.isstart=0
		left join SYS_GL_TYPE type on run.typeId = type.typeId
		left join BPM_DEFINITION def on run.defId = def.defId
		LEFT JOIN bpm_task_read tread  ON tk.TASK_ID_ = tread.TASKID
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormTable"/>
		</if>
		where tk.ASSIGNEE_=#{assignee}  and tk.end_time_ is not null and def.status!=3
		and run.status in (1,2,3,5,6,7)
		<if test="@Ognl@isNotEmpty(formTable)">
			<include refid="queryFormWhere"/>
		</if>
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject}</if>
		<if test="@Ognl@isNotEmpty(creatorId)"> AND run.creatorId = #{creatorId}</if>
		<if test="@Ognl@isNotEmpty(defId)"> AND run.defId = #{defId}</if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(beginendTime)"> AND run.endTime  >=#{beginendTime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endendTime)"> AND <![CDATA[ run.endTime <= #{endendTime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<if test="@Ognl@isNotEmpty(processName)"> AND upper(run.processName)  LIKE #{processName} </if>
		<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>
		<if test="@Ognl@isNotEmpty(tagIds)"> AND def.tagIds LIKE #{tagIds} </if>
		<if test="@Ognl@isNotEmpty(nodeKey)"> and type.nodeKey in (${nodeKey}) </if>
		<if test="@Ognl@isNotEmpty(notNodeKey)"> and (type.nodeKey not in (${notNodeKey}) or type.nodeKey is NULL) </if>
		<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalFlowNo  LIKE #{globalFlowNo} </if>
		<if test="@Ognl@isNotEmpty(allowMobile)"> AND def.allowMobile  LIKE #{allowMobile} </if>
		<if test="@Ognl@isNotEmpty(searchCondition)"> AND (run.globalFlowNo  LIKE #{searchCondition} OR upper(run.processName)  LIKE #{searchCondition} OR run.creator LIKE #{searchCondition})</if>
		<if test="@Ognl@isNotEmpty(typeIds)"> AND run.TYPEID  in
			<foreach collection="typeIds" index="index" item="typeId" open="(" close=")" separator=",">
				#{typeId}
			</foreach>
		</if>
		<if test="@Ognl@isNotEmpty(orderField)">
			order by run.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by run.createtime  desc
		</if>
	</select>
	<!--获取流程已办事宜分类统计数据-->
	<select id="getFlowAlreadyMattersCount" resultType="com.suneee.oa.model.bpm.ProcessRunAmount">
		select distinct run.defid as defId,count(distinct run.runid) total
		from BPM_PRO_RUN_HIS run  join ACT_HI_ACTINST tk on run.actInstId=tk.PROC_INST_ID_  and tk.isstart=0
		left join SYS_GL_TYPE type on run.typeId = type.typeId
		left join BPM_DEFINITION def on run.defId = def.defId
		where tk.ASSIGNEE_=#{assignee}  and tk.end_time_ is not null and def.status!=3
		and run.status in (1,2,3,5,6,7)
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject}</if>
		<if test="@Ognl@isNotEmpty(creatorId)"> AND run.creatorId = #{creatorId}</if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(beginendTime)"> AND run.endTime  >=#{beginendTime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endendTime)"> AND <![CDATA[ run.endTime <= #{endendTime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<if test="@Ognl@isNotEmpty(processName)"> AND upper(run.processName)  LIKE #{processName} </if>
		<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>
		<if test="@Ognl@isNotEmpty(tagIds)"> AND def.tagIds LIKE #{tagIds} </if>
		<if test="@Ognl@isNotEmpty(nodeKey)"> and type.nodeKey in (${nodeKey}) </if>
		<if test="@Ognl@isNotEmpty(notNodeKey)"> and (type.nodeKey not in (${notNodeKey}) or type.nodeKey is NULL) </if>
		<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalFlowNo  LIKE #{globalFlowNo} </if>
		<if test="@Ognl@isNotEmpty(allowMobile)"> AND def.allowMobile  LIKE #{allowMobile} </if>
		<if test="@Ognl@isNotEmpty(typeIdList)">
			AND def.typeId IN
			<foreach collection="typeIdList" item="typeId" open="(" separator="," close=")">
				#{typeId}
			</foreach>
		</if>
		GROUP BY run.defid
	</select>

	<!--办结事宜	-->
	<select id="getCompletedMattersList" resultMap="ProcessRun">
		select distinct <include refid="runColumns"/>
		from BPM_PRO_RUN_HIS run  join ACT_HI_ACTINST tk on run.actInstId=tk.PROC_INST_ID_
		left join SYS_GL_TYPE type on run.typeId = type.typeId
		left join BPM_DEFINITION def on run.defId = def.defId
		where tk.ASSIGNEE_=#{assignee} AND ( run.status = 2 or  run.status = 3 ) and def.status!=3
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject} </if>
		<if test="@Ognl@isNotEmpty(creator)"> AND run.creator  LIKE #{creator} </if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(beginendTime)"> AND run.endTime  >=#{beginendTime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endendTime)"> AND <![CDATA[ run.endTime <= #{endendTime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(endTime)"> AND run.endTime  =#{endTime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(busDescp)"> AND run.busDescp  LIKE #{busDescp} </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<if test="@Ognl@isNotEmpty(processName)"> AND upper(run.processName)  LIKE #{processName} </if>
		<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>
		<if test="@Ognl@isNotEmpty(tagIds)"> AND def.tagIds LIKE #{tagIds} </if>
		<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalFlowNo  LIKE #{globalFlowNo} </if>
		<if test="@Ognl@isNotEmpty(allowMobile)"> AND def.allowMobile  LIKE #{allowMobile} </if>
		<if test="@Ognl@isNotEmpty(orderField)">
			order by ${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by run.endTime  desc
		</if>
	</select>


	<!--我的承办  -->
	<select id="getAlreadyMattersListAndCompletedMattersList" resultMap="ProcessRun">
		select distinct <include refid="runColumns"/>
		from BPM_PRO_RUN_HIS run  join ACT_HI_ACTINST tk on run.actInstId=tk.PROC_INST_ID_  and tk.isstart=0
		left join SYS_GL_TYPE type on run.typeId = type.typeId
		left join BPM_DEFINITION def on run.defId = def.defId
		where(( tk.ASSIGNEE_=#{assignee}  and tk.end_time_ is not null and def.status!=3
		and run.status in (1,5,6,7)) or (tk.ASSIGNEE_=#{assignee} AND ( run.status = 2 or  run.status = 3 ) and def.status!=3))
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject}</if>
		<if test="@Ognl@isNotEmpty(creatorId)"> AND run.creatorId = #{creatorId}</if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(beginendTime)"> AND run.endTime  >=#{beginendTime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endendTime)"> AND <![CDATA[ run.endTime <= #{endendTime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(status)"> AND run.status  =#{status} </if>
		<if test="@Ognl@isNotEmpty(processName)"> AND upper(run.processName)  LIKE #{processName} </if>
		<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>
		<if test="@Ognl@isNotEmpty(tagIds)"> AND def.tagIds LIKE #{tagIds} </if>
		<if test="@Ognl@isNotEmpty(nodeKey)"> and type.nodeKey in (${nodeKey}) </if>
		<if test="@Ognl@isNotEmpty(notNodeKey)"> and (type.nodeKey not in (${notNodeKey}) or type.nodeKey is NULL) </if>
		<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalFlowNo  LIKE #{globalFlowNo} </if>
		<if test="@Ognl@isNotEmpty(allowMobile)"> AND def.allowMobile  LIKE #{allowMobile} </if>
		<if test="@Ognl@isNotEmpty(orderField)">
			order by run.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by run.createtime  desc
		</if>
	</select>


	<!-- 流程查询 -->
	<select id="selectPro" resultMap="ProcessRun">
		<choose>
			<when test="proflag==0">
				select his.* from (	 select h.runId runId, h.subject subject,h.processname processname,h.createtime,
				h.creatorid creatorid,h.creator creator, -1 assignee,h.status status,h.defid defId,h.typeid typeid,
				h.actinstid actinstid, 0 proflag,lower(h.subject) lSubject  from bpm_pro_run_his h where h.creatorid= #{currentUserId} )
				his
				left join SYS_GL_TYPE type on his.typeId = type.typeId
				left join BPM_DEFINITION def on his.defId = def.defId
				<where>
					<if test="@Ognl@isNotEmpty(subject)"> AND his.lSubject LIKE #{subject}  ESCAPE '|'</if>
					<if test="@Ognl@isNotEmpty(creatorId)"> AND his.creatorId = #{creatorId}</if>
					<if test="@Ognl@isNotEmpty(begincreatetime)"> AND his.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
					<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ his.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
					<if test="@Ognl@isNotEmpty(status)"> AND his.status  =#{status} </if>
					<if test="@Ognl@isNotEmpty(processName)"> AND his.processName  LIKE #{processName} </if>
					<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>
					<if test="@Ognl@isNotEmpty(assignee)"> AND his.assignee = #{assignee}</if>
				</where>

			</when>
			<when test="proflag==1">

				select distinct his.runId runId,  his.subject subject,his.processname processname,
				his.createtime,his.creatorid creatorid,his.creator creator, ha.assignee_ assignee, his.status status,
				his.defid defId,his.typeid typeid,his.actinstid actinstid, 1 proflag,lower(his.subject) lSubject from bpm_pro_run_his his
				join  act_hi_actinst  ha  on his.actinstid =ha.proc_inst_id_ and ha.ISSTART=0 and  ha.assignee_ = #{currentUserId}
				left join SYS_GL_TYPE type on his.typeId = type.typeId
				left join BPM_DEFINITION def on his.defId = def.defId

				<where>
					<if test="@Ognl@isNotEmpty(subject)"> AND his.subject LIKE #{subject}  ESCAPE '|'</if>
					<if test="@Ognl@isNotEmpty(creatorId)"> AND his.creatorId = #{creatorId}</if>
					<if test="@Ognl@isNotEmpty(begincreatetime)"> AND his.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
					<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ his.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
					<if test="@Ognl@isNotEmpty(status)"> AND his.status  =#{status} </if>
					<if test="@Ognl@isNotEmpty(processName)"> AND his.processName  LIKE #{processName} </if>
					<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>

					<if test="@Ognl@isNotEmpty(tagIds)"> AND def.tagIds LIKE #{tagIds} </if>
					<if test="@Ognl@isNotEmpty(assignee)"> AND his.assignee = #{assignee}</if>
				</where>

			</when>
			<otherwise>
				select distinct his.runId,his.subject,his.processname,his.createtime,his.creatorid,his.creator,his.status,his.defId,his.typeid,his.actInstId ,lSubject from (
				select t.runId runId, t.subject subject,t.processname processname,t.createtime,t.creatorid creatorid,t.creator creator, null assignee,t.status status,t.defid defId,t.typeid typeid,t.actinstid actinstid, 0 proflag,lower(t.subject) lSubject from bpm_pro_run_his t where t.creatorid= #{currentUserId}
				union all (
				select t.runId runId, t.subject subject,t.processname processname,t.createtime,t.creatorid creatorid,t.creator creator, ha.assignee_ assignee, t.status status,t.defid defId,t.typeid typeid,t.actinstid actinstid, 1 proflag,lower(t.subject) lSubject from bpm_pro_run_his t
				join  act_hi_actinst  ha  on t.actinstid =ha.proc_inst_id_ and ha.ISSTART=0 where  ha.assignee_ = #{currentUserId}  )
				) his
				left join SYS_GL_TYPE type on his.typeId = type.typeId
				left join BPM_DEFINITION def on his.defId = def.defId

				<where>
					<if test="@Ognl@isNotEmpty(subject)"> AND his.lSubject LIKE #{subject}  ESCAPE '|'</if>
					<if test="@Ognl@isNotEmpty(creatorId)"> AND his.creatorId = #{creatorId}</if>
					<if test="@Ognl@isNotEmpty(begincreatetime)"> AND his.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
					<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ his.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
					<if test="@Ognl@isNotEmpty(status)"> AND his.status  =#{status} </if>
					<if test="@Ognl@isNotEmpty(processName)"> AND his.processName  LIKE #{processName} </if>
					<if test="@Ognl@isNotEmpty(nodePath)">AND type.nodePath like #{nodePath} </if>

					<if test="@Ognl@isNotEmpty(assignee)"> AND his.assignee = #{assignee}</if>
				</where>
			</otherwise>
		</choose>

		<if test="@Ognl@isNotEmpty(orderField)">
			order by his.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by his.createtime  desc
		</if>

	</select>

	<!-- 根据runid找到copyid -->
	<select id="getCopyIdByRunid" parameterType="java.util.Map" resultMap="ProcessRun">
	    SELECT  CPT.COPY_ID copyId
	    FROM BPM_PRO_CPTO CPT
            where cpt.run_id = #{runId} AND cpt.CC_UID=#{userId}
	</select>


	<select id="getRefList_oracle" resultMap="ProcessRun">
   		select *  from bpm_pro_run_his t where t.defid=#{defId} and t.creatorid=#{creatorId} and t.status=2 and rownum &lt;=#{instanceAmount}
   		order by CREATETIME desc
     </select>
	<select id="getRefList_mysql" resultMap="ProcessRun">
   		select *  from bpm_pro_run_his t where t.defid=#{defId} and t.creatorid=#{creatorId} and t.status=2 order by CREATETIME desc
   		limit #{instanceAmount}
     </select>
	<select id="getRefList_mssql" resultMap="ProcessRun">
   		select top #{instanceAmount} *  from bpm_pro_run_his t where t.defid=#{defId} and t.creatorid=#{creatorId} and t.status=2
   		order by CREATETIME desc
     </select>
	<select id="getRefList_db2" resultMap="ProcessRun">
   		select * from (select row_number() over() as rownum, hi.* form bpm_pro_run_his hi) as t where t.defid=#{defId} and t.creatorid=#{creatorId} and t.status=2 and rownum &lt;=#{instanceAmount}
   		order by CREATETIME desc
     </select>

	<select id="getRefListCopyTo_oracle" resultMap="ProcessRun">
     	select * from (select t.*,c.CREATE_ID "copyto.createId",c.CREATOR as "copyto.creator",c.CP_TYPE as "copyto.cpType"
		from bpm_pro_run_his t,BPM_PRO_CPTO c where  t.defid=#{defId} and c.cc_Uid=#{curUser}
		and t.runId=c.run_Id  and t.status=2
     	order by CREATETIME desc)temp where rownum &lt;=#{instanceAmount}
     </select>
	<select id="getRefListCopyTo_mysql" resultMap="ProcessRun">
     	select t.*,c.CREATE_ID "copyto.createId",c.CREATOR as "copyto.creator",c.CP_TYPE as "copyto.cpType"
		from bpm_pro_run_his t,BPM_PRO_CPTO c where  t.defid=#{defId} and c.cc_Uid=#{curUser}
		and t.runId=c.run_Id  and t.status=2 order by CREATETIME desc limit #{instanceAmount}
     </select>
	<select id="getRefListCopyTo_mssql" resultMap="ProcessRun">
     	select top #{instanceAmount} t.*,c.CREATE_ID "copyto.createId",c.CREATOR as "copyto.creator",c.CP_TYPE as "copyto.cpType"
		from bpm_pro_run_his t,BPM_PRO_CPTO c where  t.defid=#{defId} and c.cc_Uid=#{curUser}
		and t.runId=c.run_Id  and t.status=2 order by CREATETIME desc
     </select>
	<select id="getRefListCopyTo_db2" resultMap="ProcessRun">
     	select * from (select * (select row_number() over() as rownum,t.*,c.CREATE_ID "copyto.createId",c.CREATOR as "copyto.creator",c.CP_TYPE as "copyto.cpType"
     	from bpm_pro_run_his t,BPM_PRO_CPTO c where t.runId=c.run_Id and c.cc_Uid=#{curUser}) as temp
		where temp.defid=#{defId} and temp.status=2
     	order by CREATETIME desc)temp where rownum &lt;=#{instanceAmount}
     </select>


	<delete id="delSubHistoryByProcInstId" parameterType="java.lang.String">
		DELETE FROM bpm_pro_run_his
		WHERE ACTINSTID in (select a.ID_ from ACT_RU_EXECUTION a where  a.PROC_INST_ID_=#{procInstId} and a.ID_!=#{procInstId})
	</delete>

	<delete id="delHistoryByActinstid" parameterType="java.lang.String">
		DELETE FROM bpm_pro_run_his
		WHERE ACTINSTID =#{actInstId}
	</delete>

	<delete id="delSubProByProcInstId" parameterType="java.lang.String">
		DELETE FROM BPM_PRO_RUN
		WHERE ACTINSTID in (select a.ID_ from ACT_RU_EXECUTION a where  a.PROC_INST_ID_=#{procInstId} and a.ID_!=#{procInstId})
	</delete>

	<delete id="delProByActinstid" parameterType="java.lang.String">
		DELETE FROM BPM_PRO_RUN
		WHERE ACTINSTID =#{actInstId}
	</delete>

	<select id="getByBusinessKeyAndActDefId" parameterType="java.util.Map" resultMap="ProcessRun">
		SELECT * FROM BPM_PRO_RUN_HIS run where businessKey=#{businessKey} and actDefId=#{actDefId}
	</select>

	<select id="getByBusinessKeyWithActInstId" parameterType="java.lang.String" resultType="int">
		SELECT count(*) FROM ACT_HI_PROCINST
		WHERE
		BUSINESS_KEY_=#{businessKey}
	</select>

	<select id="delActHiProcessInstanceByRunId" parameterType="java.lang.Long">
		DELETE FROM ACT_HI_PROCINST WHERE PROC_INST_ID_ IN
			(SELECT run.ACTINSTID FROM BPM_PRO_RUN_HIS run WHERE run.RUNID=#{runId})
	</select>

	<select id="delActHiProcessInstanceByActinstid" parameterType="java.lang.Long">
		DELETE FROM ACT_HI_PROCINST WHERE PROC_INST_ID_ =#{actinstid}
	</select>

	<select id="delSubActHiProcessInstanceByActinstid" parameterType="java.lang.String">
		DELETE FROM ACT_HI_PROCINST
		WHERE PROC_INST_ID_ IN (select a.ID_ from ACT_RU_EXECUTION a where  a.PROC_INST_ID_=#{procInstId} and a.ID_!=#{procInstId})
	</select>

	<select id="delActHiProcessInstanceByActDefId" parameterType="java.lang.String">
		DELETE FROM ACT_HI_PROCINST WHERE PROC_DEF_ID_ =#{actDefId}
	</select>

	<select id="getByHistoryId" parameterType="java.lang.Long" resultMap="ProcessRun">
		select distinct *  from bpm_pro_run_his t where t.runId=#{relRunId}
	</select>


	<delete id="delByBusinessKey">
		delete from bpm_pro_run  where businessKey=#{businessKey}
	</delete>
	<delete id="delByBusinessKeyHis">
		delete from bpm_pro_run_his  where businessKey=#{businessKey}
	</delete>
	<delete id="delByBusinessKeyNum">
		delete from bpm_pro_run  where BUSINESSKEY_NUM=#{businessKeyNum}
	</delete>
	<delete id="delByBusinessKeyNumHis">
		delete from bpm_pro_run  where BUSINESSKEY_NUM=#{businessKeyNum}
	</delete>

	<!-- 我的办结和抄送转发给我的办结流程 -->
	<select id="getMyCompletedAndCptoList" resultMap="ProcessRun">
		select distinct <include refid="runColumns"/>
		from BPM_PRO_RUN_HIS run
		left join BPM_DEFINITION def on run.defId = def.defId
		where  def.status!=3
		AND ( run.status = 2 or  run.status = 3 )
		AND (run.creatorId =#{creatorId} or run.runid in (select run_id from BPM_PRO_CPTO where cc_uid = #{creatorId}))
		<if test="@Ognl@isNotEmpty(referDefKey)"> AND def.defkey = #{referDefKey} </if>
		<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalflowno  LIKE #{globalFlowNo} </if>
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject} </if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(searchCondition)">
			AND (run.subject LIKE #{searchCondition} OR run.globalflowno  LIKE #{searchCondition})
		</if>
		<if test="@Ognl@isNotEmpty(orderField)">
			order by run.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by run.createtime  desc
		</if>
	</select>

	<!-- 我的流程和抄送转发给我的办结流程	1,2,3,6
		1:运行状态,2:结束状态,3:人工终止,6:已退回

	-->
	<select id="getMyFlowsAndCptoList" resultMap="ProcessRun">
		select distinct <include refid="runColumns"/>
		from BPM_PRO_RUN_HIS run
		left join BPM_DEFINITION def on run.defId = def.defId
		where  def.status!=3
		AND run.status in (1,2,3,6)
		AND (run.creatorId =#{creatorId} or run.runid in (select run_id from BPM_PRO_CPTO where cc_uid = #{creatorId}))
		<if test="@Ognl@isNotEmpty(referDefKeyList)">
			AND	def.defkey in
			<foreach collection="referDefKeyList" index="index" item="defKey" open="(" close=")" separator=",">
				#{defKey}
			</foreach>
		</if>
		<if test="@Ognl@isNotEmpty(referDefKey)"> AND def.defkey = #{referDefKey} </if>

		<if test="@Ognl@isNotEmpty(globalFlowNo)"> AND run.globalflowno  LIKE #{globalFlowNo} </if>
		<if test="@Ognl@isNotEmpty(subject)"> AND upper(run.subject)  LIKE #{subject} </if>
		<if test="@Ognl@isNotEmpty(begincreatetime)"> AND run.createtime  >=#{begincreatetime,jdbcType=DATE} </if>
		<if test="@Ognl@isNotEmpty(endcreatetime)"> AND <![CDATA[ run.createtime <= #{endcreatetime,jdbcType=DATE}  ]]> </if>
		<if test="@Ognl@isNotEmpty(searchCondition)">
			AND (run.subject LIKE #{searchCondition} OR run.globalflowno  LIKE #{searchCondition})
		</if>
		<if test="@Ognl@isNotEmpty(orderField)">
			order by run.${orderField} ${orderSeq}
		</if>
		<if test="@Ognl@isEmpty(orderField)">
			order by run.createtime  desc
		</if>
	</select>
	<select id="getUseridByAliasname" parameterType="java.lang.String" resultType="com.suneee.platform.model.system.SysUser">
		select * FROM sys_user WHERE alias_name=#{alias_name}
	</select>
	<select id="getUseridByAccount" parameterType="java.lang.String" resultType="com.suneee.platform.model.system.SysUser">
		select * FROM sys_user WHERE ACCOUNT=#{account}
	</select>
	<select id="getUseridByUserId" parameterType="java.lang.String" resultType="com.suneee.platform.model.system.SysUser">
		select * FROM sys_user WHERE USERID=#{startUserId}
	</select>
	<select id="getUseridByUser" parameterType="java.lang.String" resultType="com.suneee.platform.model.system.SysUser">
		select alias_name aliasname,fullname fullname FROM sys_user WHERE FULLNAME=#{creator} GROUP BY fullname
	</select>
	<update id="addExtend">
		update BPM_PRO_RUN SET extend = #{extend} where RUNID=#{runId}
	</update>
</mapper>